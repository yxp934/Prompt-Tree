# 开发路线图：AI 对话客户端 (ai-chat-client)

## 项目概览

**项目目标**：构建一个基于拓扑节点的上下文可视化AI客户端，让用户像管理Git树一样管理AI对话历史。

**核心技术栈**：
- Next.js 14 + React 18 + TypeScript
- Zustand（状态管理）
- React Flow（树图可视化）
- IndexedDB（数据持久化）
- OpenAI API
- Tailwind CSS

**开发策略**：渐进式开发，从简单的单分支对话开始，逐步演进到完整的树状拓扑结构。

---

## 当前进展（最后更新：2026-01-26）

- ✅ 已实现：IndexedDB 数据层、Zustand Store、基础聊天、ReactFlow 树视图、Context Box、压缩节点（含 AI 生成摘要/元指令）
- 🧩 2026-01-24：修复 `Compress Selected/Context` 在 ContextBox 多节点时不可点击（支持以 ContextBox 链式节点作为默认压缩目标），并用 Playwright MCP 验证通过
- 🧩 2026-01-25：压缩节点定位到被压缩链的末端节点位置；压缩后默认折叠隐藏被压缩节点（树画布仅显示压缩节点），支持点击压缩节点展开/折叠，并保持后续节点可继续连接
- 🧩 2026-01-25：点击树节点时 ContextBox 自动刷新为当前路径，并保持拖拽添加/重排能力（Playwright MCP 验证）
- 🧩 2026-01-25：压缩节点改为挂载到被压缩链的尾节点（展开时作为子节点），折叠视图保持压缩节点可见，并保留分支节点不被误折叠；修复压缩弹窗提示 `entry is not defined`（Playwright MCP 验证）
- 🧩 2026-01-25：分支列表与命名编辑、叶子分支快捷切换、拖拽改父节点（Playwright MCP 验证）
- 🧩 2026-01-25：右键压缩/解压入口 + 压缩节点折叠标记（Playwright MCP 验证）
- 🧩 2026-01-25：Header 组件拆分、主题切换/持久化、设置项扩展（模型/温度/最大 tokens），移动端侧栏/Context 抽屉（Playwright MCP 验证）
- 🧩 2026-01-26：设置页补充后端代理接口（模型列表/健康检测/模型测试），前端改用本地 API 代理访问并支持连接检测
- 🧩 2026-01-26：设置页导航与面板完善（默认模型/常规/显示/数据/关于），默认模型测试、API Key/Base URL 与生成参数管理、主题切换与数据清理/重置
- 🧩 2026-01-26：多模型选择与并行回复：默认模型页聚合启用模型，主输入框支持多选，发送后生成同父节点分支并在对话/树/Context 中显示模型名称

---

## 开发阶段

### 🎯 阶段 0：项目初始化（1-2天）

**目标**：搭建项目基础架构，配置开发环境

#### 任务列表

- [x] 创建Next.js项目
  ```bash
  npx create-next-app@latest ai-chat-client --typescript --tailwind --app
  ```

- [x] 安装核心依赖
  - `zustand` - 状态管理
  - `reactflow` - 树图可视化
  - `uuid` - UUID生成
  - `date-fns` - 日期处理

- [x] 配置TypeScript
  - 启用严格模式
  - 配置路径别名（@/components, @/lib, @/store）

- [x] 配置ESLint和Prettier
  - 安装必要的代码规范插件
  - 配置.format和.lintignore

- [x] 设置项目目录结构
  ```
  src/
  ├── app/
  ├── components/
  ├── lib/
  ├── store/
  └── types/
  ```

- [x] 创建基础布局组件
  - `app/layout.tsx` - 根布局
  - `app/page.tsx` - 主页面
  - `components/layout/MainLayout.tsx` - 主布局容器

- [x] 配置Tailwind CSS
  - 设置主题色
  - 定义通用样式类

**交付物**：
- ✅ 可运行的Next.js项目
- ✅ 完整的项目目录结构
- ✅ 开发环境配置完成

**验收标准**：
- 项目可以正常启动（`npm run dev`）
- 页面可以正常访问（http://localhost:3000）
- TypeScript编译无错误

---

### 🎯 阶段 1：数据层实现（2-3天）

**目标**：实现IndexedDB封装和核心数据模型

#### 任务列表

- [x] 创建TypeScript类型定义
  - [x] `types/node.ts` - 节点类型
  - [x] `types/tree.ts` - 树类型
  - [x] `types/context.ts` - 上下文类型
  - [x] `types/index.ts` - 统一导出

- [x] 实现IndexedDB封装
  - [x] `lib/db/indexedDB.ts` - 数据库初始化
  - [x] `lib/db/objectStore.ts` - ObjectStore封装
  - [x] `lib/db/schema.ts` - 数据库Schema配置

- [x] 实现节点数据访问层
  - [x] `lib/services/nodeService.ts`
    - CRUD操作
    - 路径查询
    - 子节点查询
    - 批量操作

- [x] 实现树数据访问层
  - [x] `lib/services/treeService.ts`
    - 树CRUD操作
    - 树列表查询
    - 树加载

- [x] 编写单元测试
  - [x] IndexedDB操作测试
  - [x] 节点服务测试
  - [x] 树服务测试

**交付物**：
- ✅ 完整的类型定义系统
- ✅ 类型安全的IndexedDB封装
- ✅ 节点和树的CRUD服务
- ✅ 单元测试覆盖率 > 80%

**验收标准**：
- 可以成功创建、读取、更新、删除节点
- 可以创建和管理多个对话树
- 所有测试通过

---

### 🎯 阶段 2：状态管理实现（1-2天）

**目标**：实现Zustand全局状态管理

#### 任务列表

- [x] 创建Zustand Store
  - [x] `store/useStore.ts` - 主Store
  - [x] `store/nodeSlice.ts` - 节点状态
  - [x] `store/treeSlice.ts` - 树状态
  - [x] `store/contextSlice.ts` - 上下文状态
  - [x] `store/uiSlice.ts` - UI状态

- [x] 实现状态持久化
  - [x] 将IndexedDB与Store同步
  - [x] 自动保存机制
  - [x] 错误处理和重试

- [x] 实现React Hooks
  - [x] `lib/hooks/useTree.ts`
  - [x] `lib/hooks/useNode.ts`
  - [x] `lib/hooks/useContext.ts`
  - [x] `lib/hooks/useStore.ts`

**交付物**：
- ✅ 完整的Zustand Store实现
- ✅ 状态与数据库同步
- ✅ 自定义Hooks封装

**验收标准**：
- Store状态变更会自动保存到IndexedDB
- 刷新页面后状态可以恢复
- Hooks可以在组件中正常使用

---

### 🎯 阶段 3：第一个里程碑 - 单分支对话（3-4天）

**目标**：实现基本的单分支对话功能（类似常规聊天工具）

#### 任务列表

- [x] 创建基础UI组件
  - [x] `components/common/Button.tsx`
  - [x] `components/common/Input.tsx`
  - [x] `components/common/Modal.tsx`

- [x] 实现ChatView组件
  - [x] `components/chat/ChatView.tsx` - 对话视图容器
  - [x] `components/chat/MessageList.tsx` - 消息列表
  - [x] `components/chat/MessageItem.tsx` - 单条消息
  - [x] `components/chat/InputArea.tsx` - 输入区域

- [x] 实现OpenAI API集成
  - [x] `lib/services/llmService.ts` - LLM服务
  - [x] `lib/services/openaiClient.ts` - OpenAI客户端
  - [x] API Key管理（localStorage）

- [x] 实现消息发送流程
  - [x] 用户输入 -> 创建用户节点
  - [x] 调用OpenAI API
  - [x] 创建AI回复节点
  - [x] 更新UI显示

- [x] 实现Token计算
  - [x] `lib/services/tokenService.ts`
  - [x] 简单的Token估算算法

- [x] 添加加载状态和错误处理
  - [x] 发送消息时的加载动画
  - [x] API调用失败的错误提示

**交付物**：
- ✅ 可用的单分支对话功能
- ✅ OpenAI API集成
- ✅ Token计数显示

**验收标准**：
- 用户可以输入消息并发送
- AI可以正常回复
- 消息历史正确显示
- Token数量实时显示

**此阶段完成后，你将拥有一个基本的聊天工具！** 🎉

---

### 🎯 阶段 4：树状图可视化（3-4天）

**目标**：使用React Flow实现对话树的显示和交互

#### 任务列表

- [x] 集成React Flow
  - [x] 安装依赖
  - [x] `components/tree/TreeView.tsx` - 树视图容器
  - [x] 配置基础布局

- [x] 实现自定义节点组件
  - [x] `components/tree/TreeNode.tsx` - 自定义节点
  - [x] 节点样式设计（用户/AI/系统节点）
  - [x] 节点交互（点击、右键菜单、编辑）

- [x] 实现自定义连线组件
  - [x] `components/tree/TreeEdge.tsx` - 自定义连线
  - [x] 连线样式设计

- [x] 实现DAG服务
  - [x] `lib/services/dagService.ts`
  - [x] 树到React Flow图的转换
  - [x] 节点布局算法

- [x] 实现树操作功能
  - [x] 节点点击选择
  - [x] 路径高亮
  - [x] 缩放和平移
  - [x] MiniMap显示

- [x] 添加树控制栏
  - [x] `components/tree/TreeControls.tsx`
  - [x] 自动布局按钮
  - [x] 适应视图按钮

**交付物**：
- ✅ 可视化的树状图
- ✅ 节点和连线的交互
- ✅ 树布局算法

**验收标准**：
- 对话历史以树状图显示
- 点击节点可以查看详情
- 树图可以缩放和平移
- 路径高亮正确显示

---

### 🎯 阶段 5：分支管理（2-3天）

**目标**：实现分支创建和管理功能

#### 任务列表

- [ ] 实现分支创建
  - [x] 在任意节点上创建新分支
  - [x] 分支命名
  - [x] 分支切换

- [ ] 实现分支编辑
  - [x] 编辑节点内容
  - [x] 删除节点
  - [x] 删除整条分支

- [ ] 添加分支管理UI
  - [x] 右键菜单
  - [x] 分支列表侧边栏
  - [ ] 分支切换动画

- [ ] 实现节点拖拽
  - [x] 拖拽节点改变位置
  - [x] 拖拽节点改变父节点

**交付物**：
- ✅ 完整的分支管理功能
- ✅ 直观的分支操作UI

**验收标准**：
- 可以在任意节点创建新分支
- 可以切换不同分支
- 可以编辑和删除节点
- 拖拽功能正常工作

---

### 🎯 阶段 6：上下文组装台（3-4天）

**目标**：实现革命性的上下文组装功能

#### 任务列表

- [x] 实现ContextPanel组件
  - [x] `components/layout/ContextPanel.tsx` - 上下文面板（含 ContextCard/预览/压缩入口）

- [x] 实现Token计量器
  - [x] 进度条显示
  - [x] 百分比计算
  - [x] 超限显示（进度条上限）

- [x] 实现上下文预览
  - [x] 查看完整上下文内容

- [x] 实现节点拖拽到上下文
  - [x] 从树状图拖拽节点到上下文箱子
  - [x] 拖拽排序
  - [x] 拖拽移除

- [x] 实现上下文构建服务
  - [x] `store/contextSlice.ts` - 构建最终上下文（buildContextContent）
  - [x] `lib/services/contextBoxService.ts` - ContextBox 持久化

- [x] 集成到消息发送流程
  - [x] 发送消息时使用上下文箱子
  - [x] 显示上下文Token占用

**交付物**：
- ✅ 上下文组装台UI
- ✅ Token计量器
- ✅ 上下文预览功能
- ✅ 拖拽交互

**验收标准**：
- 可以从树状图拖拽节点到上下文箱子
- Token计量器实时更新
- 上下文预览正确显示
- 发送消息时使用选定的上下文

**此阶段完成后，产品核心功能基本完成！** 🎉

---

### 🎯 阶段 7：节点压缩功能（2-3天）

**目标**：实现节点压缩和元指令提取

#### 任务列表

- [x] 实现压缩服务
  - [x] `lib/services/compressionService.ts`
  - [x] 节点压缩逻辑
  - [x] 元指令提取算法

- [x] 实现AI辅助压缩
  - [x] 调用LLM生成摘要/建议（Generate with AI）
  - [x] 提取元指令
  - [x] 生成压缩节点

- [ ] 实现压缩UI
  - [x] 框选节点
  - [x] 右键菜单"压缩"
  - [x] 压缩预览
  - [x] 确认压缩

- [ ] 实现压缩节点显示
  - [x] 主题背景标识
  - [x] 摘要显示
  - [x] 展开/折叠

- [ ] 实现压缩节点操作
  - [x] 查看压缩内容（摘要/预览）
  - [x] 解压缩
  - [x] 编辑摘要

**交付物**：
- ✅ 节点压缩功能
- ✅ AI辅助摘要生成
- ✅ 元指令提取
- ✅ 压缩节点UI

**验收标准**：
- 可以框选多个节点并压缩
- 压缩后节点正确显示
- 摘要和元指令正确提取
- 可以解压缩

---

### 🎯 阶段 8：UI优化和主题（2天）

**目标**：优化UI体验，实现主题切换

#### 任务列表

- [x] 实现侧边栏
  - [x] `components/layout/Sidebar.tsx`
  - [x] 树列表显示
  - [x] 树切换
  - [x] 树创建和删除

- [ ] 实现Header
  - [x] `components/layout/Header.tsx`
  - [x] 标题显示
  - [x] 设置按钮
  - [x] 主题切换

- [ ] 实现主题系统
  - [x] 亮色主题（默认）
  - [x] 暗色主题
  - [x] 主题切换动画
  - [x] 主题持久化

- [ ] UI细节优化
  - [x] 响应式布局
  - [ ] 动画和过渡效果
  - [ ] 加载骨架屏
  - [ ] 空状态提示

- [ ] 实现设置页面
  - [x] API Key配置
  - [x] 模型选择
  - [x] 主题设置
  - [ ] 数据管理（清空、导出）

**交付物**：
- ✅ 完整的布局系统
- ✅ 主题切换功能
- ✅ 设置页面

**验收标准**：
- 布局在不同屏幕尺寸下正常显示
- 主题切换平滑无闪烁
- 设置功能正常工作

---

### 🎯 阶段 9：数据导出和导入（2天）

**目标**：实现数据的导出和导入功能

#### 任务列表

- [ ] 实现导出服务
  - [ ] `lib/services/exportService.ts`
  - [ ] 导出为JSON
  - [ ] 导出为Markdown
  - [ ] 导出为纯文本

- [ ] 实现导入服务
  - [ ] `lib/services/importService.ts`
  - [ ] 从JSON导入
  - [ ] 数据验证
  - [ ] 错误处理

- [ ] 实现导出UI
  - [ ] 导出对话框
  - [ ] 格式选择
  - [ ] 下载按钮

- [ ] 实现导入UI
  - [ ] 文件上传
  - [ ] 导入预览
  - [ ] 确认导入

- [ ] 添加批量操作
  - [ ] 批量导出
  - [ ] 批量删除
  - [ ] 数据清理

**交付物**：
- ✅ 导出功能（JSON/Markdown/Text）
- ✅ 导入功能（JSON）
- ✅ 导入导出UI

**验收标准**：
- 可以导出单个对话树
- 可以导入之前的对话数据
- 导入后数据完整性正确

---

### 🎯 阶段 10：测试和优化（2-3天）

**目标**：全面测试和性能优化

#### 任务列表

- [ ] 功能测试
  - [ ] 所有功能点测试
  - [ ] 边界情况测试
  - [ ] 错误处理测试

- [ ] 性能优化
  - [ ] React组件优化（memo、useMemo、useCallback）
  - [ ] 大量节点时的性能优化
  - [ ] 虚拟滚动
  - [ ] 图片懒加载

- [ ] 代码质量
  - [ ] TypeScript严格模式检查
  - [ ] ESLint规则检查
  - [ ] 代码格式化
  - [ ] 添加代码注释

- [ ] 安全性检查
  - [ ] API Key安全存储
  - [ ] XSS防护
  - [ ] 输入验证

- [ ] 浏览器兼容性测试
  - [ ] Chrome
  - [ ] Firefox
  - [ ] Safari
  - [ ] Edge

- [ ] 编写用户文档
  - [ ] README.md
  - [ ] 使用指南
  - [ ] 快捷键列表
  - [ ] FAQ

**交付物**：
- ✅ 完整测试报告
- ✅ 性能优化完成
- ✅ 用户文档

**验收标准**：
- 所有核心功能正常工作
- 没有 TypeScript 错误
- 性能测试通过（100个节点无卡顿）
- 主流浏览器兼容

---

### 🎯 阶段 11：部署和发布（1-2天）

**目标**：部署应用并准备发布

#### 任务列表

- [ ] 构建优化
  - [ ] 生产环境构建
  - [ ] 代码分割
  - [ ] 资源压缩
  - [ ] CDN配置

- [ ] 准备部署
  - [ ] Vercel配置
  - [ ] 环境变量配置
  - [ ] 域名配置

- [ ] 部署应用
  - [ ] 部署到Vercel
  - [ ] 配置自定义域名
  - [ ] 测试生产环境

- [ ] 准备发布
  - [ ] 创建GitHub仓库
  - [ ] 编写Release Notes
  - [ ] 创建标签

- [ ] 推广准备
  - [ ] 演示视频
  - [ ] 截图和GIF
  - [ ] 产品介绍

**交付物**：
- ✅ 生产环境部署
- ✅ GitHub仓库
- ✅ 发布文档

**验收标准**：
- 生产环境可正常访问
- 所有功能正常工作
- 性能满足要求

---

## 未来功能（v2.0+）

### 🚀 高级功能

- [ ] **多LLM提供商支持**
  - Anthropic Claude
  - Google Gemini
  - 本地模型（Ollama）
  - 自定义API端点

- [ ] **协作功能**
  - 分享对话树
  - 多人实时协作
  - 评论和批注

- [ ] **AI功能增强**
  - 智能节点推荐
  - 自动分支建议
  - 智能压缩建议
  - 节点相似度分析

- [ ] **数据分析**
  - 对话统计
  - Token使用分析
  - 时间线视图
  - 热力图

- [ ] **插件系统**
  - 自定义节点类型
  - 自定义压缩算法
  - 自定义导出格式
  - 第三方集成

- [ ] **移动端适配**
  - 响应式设计优化
  - 移动端手势
  - PWA支持

- [ ] **云端同步**
  - 账号系统
  - 数据云端备份
  - 多设备同步

---

## 开发时间线

### 乐观估计（全职开发）
- **MVP（阶段0-3）**：2周
- **核心功能（阶段4-6）**：3周
- **完善功能（阶段7-9）**：2周
- **测试发布（阶段10-11）**：1周

**总计：约8周（2个月）**

### 现实估计（业余开发）
- **MVP（阶段0-3）**：1个月
- **核心功能（阶段4-6）**：1.5个月
- **完善功能（阶段7-9）**：1个月
- **测试发布（阶段10-11）**：0.5个月

**总计：约4个月**

---

## 里程碑节点

| 里程碑 | 阶段 | 预计完成 | 核心功能 |
|--------|------|---------|---------|
| 🥉 MVP v0.1 | 阶段0-3 | 第2周 | 单分支对话 |
| 🥈 Alpha v0.5 | 阶段4-6 | 第5周 | 树状图+上下文组装 |
| 🥇 Beta v0.9 | 阶段7-9 | 第7周 | 压缩+导出 |
| 🎉 v1.0 正式版 | 阶段10-11 | 第8周 | 完整功能+测试 |

---

## 风险和挑战

| 风险 | 影响 | 缓解措施 | 优先级 |
|------|------|---------|--------|
| React Flow性能问题 | 高 | 提前进行性能测试，考虑虚拟化 | P0 |
| IndexedDB兼容性 | 中 | 提供localStorage降级方案 | P1 |
| OpenAI API限制 | 中 | 实现重试机制，支持多LLM | P1 |
| 浏览器存储限制 | 低 | 定期清理提示，导出功能 | P2 |
| 大规模树布局复杂 | 高 | 简化布局算法，限制节点显示 | P0 |

---

## 技术债务跟踪

在开发过程中，我们会记录技术债务，以便在后续迭代中偿还：

### 当前技术债务
- [ ] 暂无

### 待讨论的技术决策
- [ ] 是否需要状态持久化到云？
- [ ] 是否支持多LLM提供商？
- [ ] 是否需要协作功能？

---

## 开发规范

### Git工作流
- 主分支：`main`
- 开发分支：`develop`
- 功能分支：`feature/功能名称`
- 修复分支：`fix/问题描述`

### Commit规范
```
feat: 添加功能描述
fix: 修复问题描述
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建/工具相关
```

### 代码审查
- 所有代码需要经过自审
- 关键功能需要创建PR进行审查
- 确保TypeScript无错误
- 确保测试通过

---

## 总结

这个路线图提供了一个清晰的开发路径，从简单的单分支对话开始，逐步演进到完整的树状拓扑结构。每个阶段都有明确的目标和验收标准，确保开发过程可控且高质量。

**关键成功因素**：
1. ✅ 严格遵循渐进式开发策略
2. ✅ 每个阶段完成后进行充分测试
3. ✅ 及时记录和偿还技术债务
4. ✅ 保持代码质量和文档更新
5. ✅ 定期回顾和调整计划

让我们开始构建这个革命性的AI对话客户端吧！🚀
